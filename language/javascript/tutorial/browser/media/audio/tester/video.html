<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>播放视频音轨</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }

    .container {
      background: white;
      border-radius: 16px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      padding: 40px;
      max-width: 800px;
      width: 100%;
      text-align: center;
    }

    .video-container {
      position: relative;
      background: #000;
      border-radius: 12px;
      overflow: hidden;
      margin-bottom: 20px;
      aspect-ratio: 16 / 9;
    }

    .video-display {
      width: 100%;
      height: 100%;
      display: block;
      object-fit: contain;
    }

    h1 {
      color: #333;
      margin-bottom: 30px;
      font-size: 24px;
    }

    .file-input-wrapper {
      margin-bottom: 30px;
    }

    input[type="file"] {
      display: none;
    }

    .file-label {
      display: inline-block;
      padding: 12px 24px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .file-label:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }

    .controls {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 15px;
      margin-bottom: 20px;
    }

    .play-btn {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      border: none;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      font-size: 24px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .play-btn:hover {
      transform: scale(1.1);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }

    .play-btn:active {
      transform: scale(0.95);
    }

    .time-display {
      color: #666;
      font-size: 14px;
      font-variant-numeric: tabular-nums;
    }

    .status {
      color: #666;
      font-size: 14px;
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>播放视频音轨</h1>

    <div class="file-input-wrapper">
      <input type="file" id="videoFile" accept="video/*">
      <label for="videoFile" class="file-label">选择视频文件</label>
    </div>

    <div class="video-container">
      <video id="videoDisplay" class="video-display" muted></video>
    </div>

    <div class="controls">
      <button class="play-btn" id="playBtn">▶</button>
      <div class="time-display" id="timeDisplay">00:00 / 00:00</div>
    </div>

    <div class="status" id="status">等待选择文件</div>
  </div>

  <script>
    const videoFileInput = document.getElementById('videoFile');
    const videoDisplay = document.getElementById('videoDisplay');
    const playBtn = document.getElementById('playBtn');
    const timeDisplay = document.getElementById('timeDisplay');
    const status = document.getElementById('status');

    let videoPlayerAudio = null; // 动态创建的隐藏 video 元素，用于播放音频
    let currentVideoUrl = null; // 当前视频的 URL 对象
    let isPlaying = false;

    // 格式化时间
    function formatTime(seconds) {
      if (isNaN(seconds)) return '00:00';
      const mins = Math.floor(seconds / 60);
      const secs = Math.floor(seconds % 60);
      return `${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
    }

    // 更新时间和状态
    function updateTime() {
      const video = videoPlayerAudio || videoDisplay;
      if (video && video.duration) {
        timeDisplay.textContent = `${formatTime(video.currentTime)} / ${formatTime(video.duration)}`;
      }
    }

    // 同步播放/暂停两个视频元素
    async function syncPlay() {
      if (videoPlayerAudio && videoDisplay) {
        try {
          await Promise.all([videoPlayerAudio.play(), videoDisplay.play()]);
        } catch (error) {
          console.error('同步播放失败:', error);
          throw error;
        }
      }
    }

    async function syncPause() {
      if (videoPlayerAudio) videoPlayerAudio.pause();
      if (videoDisplay) videoDisplay.pause();
    }

    // 播放/暂停控制
    async function togglePlay() {
      if (!videoPlayerAudio || !videoPlayerAudio.src) {
        alert('请先选择视频文件');
        return;
      }

      if (isPlaying) {
        syncPause();
        playBtn.textContent = '▶';
        isPlaying = false;
        status.textContent = '已暂停';
      } else {
        try {
          await syncPlay();
          playBtn.textContent = '⏸';
          isPlaying = true;
          status.textContent = '播放中';
        } catch (error) {
          console.error('播放失败:', error);
          status.textContent = `播放失败: ${error.message}`;
        }
      }
    }

    // 同步两个视频元素的当前时间
    function syncTime() {
      if (videoPlayerAudio && videoDisplay) {
        const currentTime = videoPlayerAudio.currentTime;
        if (Math.abs(videoDisplay.currentTime - currentTime) > 0.1) {
          videoDisplay.currentTime = currentTime;
        }
      }
    }

    // 加载视频（支持URL或文件）
    function loadVideo(url, isBlobUrl = false) {
      // 清理之前的 video 元素和 URL
      if (currentVideoUrl && isBlobUrl) {
        URL.revokeObjectURL(currentVideoUrl);
        currentVideoUrl = null;
      }
      if (videoPlayerAudio) {
        videoPlayerAudio.remove();
        videoPlayerAudio = null;
      }

      status.textContent = '加载中...';

      // 如果是 Blob URL，需要保存以便后续清理
      if (isBlobUrl) {
        currentVideoUrl = url;
      }

      // 创建隐藏的 video 元素用于播放音频
      videoPlayerAudio = document.createElement('video');
      videoPlayerAudio.style.display = 'none';
      videoPlayerAudio.src = url;
      videoPlayerAudio.crossOrigin = 'anonymous'; // 允许跨域
      document.body.appendChild(videoPlayerAudio);

      // 设置显示的 video 元素（默认静音）
      videoDisplay.src = url;
      videoDisplay.muted = true; // 默认静音
      videoDisplay.crossOrigin = 'anonymous'; // 允许跨域

      // 等待视频元数据加载
      let loadedCount = 0;
      const onLoaded = function() {
        loadedCount++;
        if (loadedCount === 2) {
          status.textContent = '就绪，点击播放';
          console.log('视频加载完成，时长:', videoPlayerAudio.duration);
        }
      };

      videoPlayerAudio.addEventListener('loadedmetadata', onLoaded, { once: true });
      videoDisplay.addEventListener('loadedmetadata', onLoaded, { once: true });

      videoPlayerAudio.addEventListener('error', function() {
        status.textContent = '加载失败';
        console.error('音频视频加载失败');
      }, { once: true });

      videoDisplay.addEventListener('error', function() {
        status.textContent = '加载失败';
        console.error('显示视频加载失败');
      }, { once: true });

      // 视频事件监听 - 使用音频视频作为主控制
      videoPlayerAudio.addEventListener('timeupdate', function() {
        updateTime();
        syncTime(); // 同步显示视频的时间
      });

      videoPlayerAudio.addEventListener('play', function() {
        if (!videoDisplay.paused) return; // 避免循环触发
        videoDisplay.play().catch(err => console.error('显示视频播放失败:', err));
        playBtn.textContent = '⏸';
        isPlaying = true;
        status.textContent = '播放中';
      });

      videoPlayerAudio.addEventListener('pause', function() {
        if (videoDisplay.paused) return; // 避免循环触发
        videoDisplay.pause();
        playBtn.textContent = '▶';
        isPlaying = false;
        status.textContent = '已暂停';
      });

      videoPlayerAudio.addEventListener('ended', function() {
        videoDisplay.pause();
        playBtn.textContent = '▶';
        isPlaying = false;
        status.textContent = '播放结束';
      });

      // 同步显示视频的播放状态（作为备用）
      videoDisplay.addEventListener('play', function() {
        if (!videoPlayerAudio.paused) return;
        videoPlayerAudio.play().catch(err => console.error('音频视频播放失败:', err));
      });

      videoDisplay.addEventListener('pause', function() {
        if (videoPlayerAudio.paused) return;
        videoPlayerAudio.pause();
      });
    }

    // 处理文件选择
    videoFileInput.addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (!file) return;

      const url = URL.createObjectURL(file);
      loadVideo(url, true); // true 表示这是 Blob URL，需要清理
    });

    // 播放按钮点击
    playBtn.addEventListener('click', togglePlay);

    // 页面加载时加载默认视频
    const defaultVideoUrl = 'https://artflo-pre.stariidata.com/artflo/695cfa3a808b9xha3laqqe3932.mp4';
    loadVideo(defaultVideoUrl, false); // false 表示这是普通 URL，不需要清理

    // 页面卸载时清理
    window.addEventListener('beforeunload', function() {
      if (currentVideoUrl) {
        URL.revokeObjectURL(currentVideoUrl);
      }
      if (videoPlayerAudio) {
        videoPlayerAudio.remove();
      }
    });
  </script>
</body>
</html>
